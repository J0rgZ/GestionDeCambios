
@{
    Layout = null;
}

<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZentroApp - Ingresar al Sistema</title>
    <link href="~/Source/css/bootstrap.css" rel="stylesheet" />
    <script src="~/Source/js/jquery-3.7.1.min.js"></script>
    <script src="~/Source/js/bootstrap.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
    <link href="~/Source/css/login.css" rel="stylesheet" />
</head>
<body>
    <!-- Overlay de carga -->
    <div class="overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <div class="loading-text">Verificando credenciales...</div>
    </div>

    <!-- Mensaje de bienvenida -->
    <div class="welcome-message" id="welcomeMessage">
        <div class="welcome-title">¡Bienvenido(a)!</div>
        <div id="welcomeUser">Nombre de Usuario</div>
        <div class="welcome-role" id="welcomeRole">Rol de Usuario</div>
    </div>

    <div class="login-container">
        <div class="login-welcome d-none d-md-flex">
            <div>
                <h1>ZentroApp</h1>
                <p>Sistema de Gestión de Cambios</p>
                <p class="mt-4">Accede a tu cuenta para gestionar los cambios en tus proyectos de forma eficiente y organizada.</p>
            </div>
        </div>
        <div class="login-form">
            <div class="login-title">
                <h2 class="d-block d-md-none">ZentroApp</h2>
                <h3>Iniciar Sesión</h3>
            </div>

            @if (TempData["Error"] != null)
            {
                <div class="alert alert-danger">
                    @TempData["Error"]
                </div>
            }

            @using (Html.BeginForm("Login", "Usuarios", new { ReturnUrl = ViewBag.ReturnUrl }, FormMethod.Post, new { @class = "form-login", id = "loginForm" }))
            {
                @Html.AntiForgeryToken()

                <div class="form-group">
                    <input type="text" name="nombreUsuario" id="nombreUsuario" class="form-control" placeholder="Nombre de Usuario" required autofocus />
                    <span class="form-control-icon">
                        <i class="fas fa-user"></i>
                    </span>
                </div>

                <div class="form-group">
                    <input type="password" name="contrasena" id="contrasena" class="form-control" placeholder="Contraseña" required />
                    <span class="form-control-icon">
                        <i class="fas fa-lock"></i>
                    </span>
                </div>

                <div class="form-group">
                    <select name="rolID" id="rolID" class="form-control">
                        <option value="">-- Seleccionar Rol (Opcional) --</option>
                        <option value="1">Administrador</option>
                        <option value="2">Jefe de Proyecto</option>
                        <option value="3">Analista</option>
                        <option value="4">Desarrollador</option>
                        <option value="5">QA</option>
                        <option value="6">Cliente</option>
                        <option value="7">Comité de Cambios</option>
                    </select>
                    <span class="form-control-icon">
                        <i class="fas fa-users"></i>
                    </span>
                </div>

                <button type="submit" class="btn btn-login">Ingresar al Sistema</button>

                <div class="login-footer">
                    <p>© @DateTime.Now.Year - ZentroApp | Sistema de Gestión de Cambios</p>
                </div>
            }
        </div>
    </div>

    <script>
    $(document).ready(function() {
        // Mostrar mensajes de error del ModelState en un formato amigable
        @if(!ViewData.ModelState.IsValid)
        {
            foreach (var key in ViewData.ModelState.Keys)
            {
                foreach (var error in ViewData.ModelState[key].Errors)
                {
                    <text>
                    showErrorMessage('@Html.Raw(error.ErrorMessage)');
                    </text>
                }
            }
        }

        // Función para mostrar mensaje de error
        function showErrorMessage(message) {
            // Si ya existe un div de alerta, actualizarlo
            if ($('.alert-danger').length) {
                $('.alert-danger').html(message);
            } else {
                // Crear un nuevo div de alerta
                var alertDiv = $('<div class="alert alert-danger"></div>').text(message);
                $('.login-title').after(alertDiv);
            }
        }

        // Interceptar el envío del formulario para mostrar la animación de carga
        $('#loginForm').on('submit', function(e) {
            // Validar el formulario
            if (this.checkValidity()) {
                e.preventDefault(); // Prevenir envío normal

                // Mostrar overlay de carga
                $('#loadingOverlay').addClass('show');

                // Simular verificación de credenciales (3 segundos)
                setTimeout(function() {
                    // Ocultar overlay de carga
                    $('#loadingOverlay').removeClass('show');

                    // Obtener datos del formulario
                    var username = $('#nombreUsuario').val();
                    var rolID = $('#rolID').val();
                    var rolName = $('#rolID option:selected').text();

                    if (!rolID) {
                        rolName = "Usuario";
                    }

                    // Configurar mensaje de bienvenida
                    $('#welcomeUser').text(username);
                    $('#welcomeRole').text(rolName);

                    // Añadir clase de estilo según el rol
                    $('#welcomeRole').removeClass().addClass('welcome-role');

                    switch(rolID) {
                        case "1":
                            $('#welcomeRole').addClass('role-admin');
                            break;
                        case "2":
                            $('#welcomeRole').addClass('role-jefe');
                            break;
                        case "3":
                            $('#welcomeRole').addClass('role-analista');
                            break;
                        case "4":
                            $('#welcomeRole').addClass('role-desarrollador');
                            break;
                        case "5":
                            $('#welcomeRole').addClass('role-qa');
                            break;
                        case "6":
                            $('#welcomeRole').addClass('role-cliente');
                            break;
                        case "7":
                            $('#welcomeRole').addClass('role-comite');
                            break;
                        default:
                            $('#welcomeRole').addClass('role-admin');
                    }

                    // Mostrar mensaje de bienvenida
                    $('#welcomeMessage').addClass('show');

                    // Esperar 3 segundos y enviar el formulario
                    setTimeout(function() {
                        $('#welcomeMessage').removeClass('show');
                        $('#loginForm')[0].submit(); // Enviar el formulario original
                    }, 3000);

                }, 3000);
            }
        });
    });
    </script>
</body>
</html>